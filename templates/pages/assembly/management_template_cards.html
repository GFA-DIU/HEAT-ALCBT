{% load custom_filters %}

{% if user_templates %}
<div class="mb-4">
    <!-- All Templates List -->
    
    <!-- User Templates List -->
    <ul class="list-group mb-4">
        {% for template in user_templates %}
        <li class="list-group-item d-flex justify-content-between align-items-center position-relative" data-template-id="{{ template.id }}" data-template-name="{{ template.name }}">
            <div class="d-flex align-items-center me-3">
                <input type="checkbox" class="form-check-input template-checkbox me-2" 
                       onchange="toggleTemplateSelection('{{ template.id }}', this)">
            </div>
            <div class="flex-grow-1">
                <h6 class="mb-1" title="{{ template.name }}">{{ template.name|truncatechars:75 }}</h6>
                <div class="row">
                    <span class="text-muted col-3">{{ template.country_name|default:"Not specified" }}</span>
                    <div class="col gap-3">
                        <span class="badge border bg-transparent rounded-pill" style="border-color: #6f42c1 !important; color: #6f42c1;">{{ template.category_name|default:"Not specified" }}</span>
                        <span class="badge border border-dark text-dark bg-transparent rounded-pill">{{ template.dimension_display }}</span>
                        <span class="badge border border-info text-info bg-transparent rounded-pill">{{ template.material_count }} material{{ template.material_count|pluralize }}</span>
                        {% if template.technique_name %}
                            <span class="badge border border-secondary text-secondary bg-transparent rounded-pill">{{ template.technique_name }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="small text-muted mt-1">
                    <span><strong>Created:</strong> {{ template.created_at }}</span>
                </div>
            </div>
            <div class="ms-auto d-flex flex-column gap-2">
                {% if template.is_public %}
                    <span class="badge rounded-pill bg-secondary text-dark fw-bold align-self-end">Generic</span>
                {% endif %}
                <div class="btn-group">
                    <a class="btn btn-outline-primary btn-sm"
                       href="{% url 'template_edit' assembly_id=template.id %}?template_edit=true">
                        <i class="fas fa-edit me-1"></i>Edit
                    </a>
                    <button class="btn btn-primary btn-sm duplicate-template-btn"
                            data-template-id="{{ template.id }}" 
                            data-template-name="{{ template.name }}"
                            data-duplicate-url="{% url 'duplicate_template' template.id %}">
                        <i class="fas fa-copy me-1"></i>Duplicate
                    </button>
                    <button class="btn btn-outline-danger btn-sm"
                            data-template-id="{{ template.id }}" 
                            data-template-name="{{ template.name }}"
                            data-delete-url="{% url 'delete_template' template.id %}"
                            class="delete-template-btn">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>
                </div>
            </div>
        </li>
        {% endfor %}
    </ul>
    
    <!-- Pagination for user templates -->
    <div class="mt-3">
        <nav aria-label="Pagination">
            <ul class="pagination justify-content-center">
                <!-- Jump to First Button -->
                {% if user_templates.has_previous %}
                <li class="page-item">
                    <a class="page-link" style="cursor: pointer" 
                       hx-post="{% url 'assembly_template_management' %}?page=1" 
                       hx-target="#template-management-cards" 
                       hx-vals='{"action": "filter"}' 
                       aria-label="First">
                        <span aria-hidden="true">Start</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link" aria-hidden="true">Start</span>
                </li>
                {% endif %}

                <!-- Previous Button -->
                {% if user_templates.has_previous %}
                <li class="page-item">
                    <a class="page-link" style="cursor: pointer" 
                       hx-post="{% url 'assembly_template_management' %}?page={{ user_templates.previous_page_number }}" 
                       hx-target="#template-management-cards" 
                       hx-vals='{"action": "filter"}' 
                       aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link" aria-hidden="true">&laquo;</span>
                </li>
                {% endif %}

                <!-- Page Numbers -->
                {% for num in user_templates.paginator.page_range %}
                    {% if num >= user_templates.number|add:-2 and num <= user_templates.number|add:2 %}
                    <li class="page-item {% if num == user_templates.number %}active{% endif %}">
                        <a class="page-link" style="cursor: pointer" 
                           hx-post="{% url 'assembly_template_management' %}?page={{ num }}" 
                           hx-target="#template-management-cards" 
                           hx-vals='{"action": "filter"}'>{{ num }}</a>
                    </li>
                    {% endif %}
                {% endfor %}

                <!-- Next Button -->
                {% if user_templates.has_next %}
                <li class="page-item">
                    <a class="page-link" style="cursor: pointer" 
                       hx-post="{% url 'assembly_template_management' %}?page={{ user_templates.next_page_number }}" 
                       hx-target="#template-management-cards" 
                       hx-vals='{"action": "filter"}' 
                       aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link" aria-hidden="true">&raquo;</span>
                </li>
                {% endif %}

                <!-- Jump to Last Button -->
                {% if user_templates.has_next %}
                <li class="page-item">
                    <a class="page-link" style="cursor: pointer" 
                       hx-post="{% url 'assembly_template_management' %}?page={{ user_templates.paginator.num_pages }}" 
                       hx-target="#template-management-cards" 
                       hx-vals='{"action": "filter"}' 
                       aria-label="Last">
                        <span aria-hidden="true">End</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link" aria-hidden="true">End</span>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endif %}

{% if not user_templates and not generic_templates %}
<div class="text-center py-5">
    <div class="mb-4">
        <i class="fas fa-layer-group fa-3x text-muted"></i>
    </div>
    <h4 class="text-muted mb-3">No Templates Found</h4>
    <p class="text-muted mb-4">You haven't created any templates yet, or no templates match your current filters.</p>
    <div class="d-flex gap-2 justify-content-center">
        <a href="{% url 'home' %}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Create Your First Assembly
        </a>
        <button type="button" class="btn btn-outline-secondary" onclick="document.querySelector('form').reset(); htmx.trigger(document.querySelector('form'), 'submit');">
            <i class="fas fa-filter me-2"></i>Clear Filters
        </button>
    </div>
</div>
{% elif not user_templates %}
<div class="text-center py-4 mb-4">
    <div class="mb-3">
        <i class="fas fa-user-plus fa-2x text-muted"></i>
    </div>
    <h5 class="text-muted mb-2">No Personal Templates</h5>
    <p class="text-muted mb-3">Create assemblies in your buildings and mark them as templates to reuse them.</p>
    <a href="{% url 'home' %}" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>Go to Buildings
    </a>
</div>
{% endif %}

<script>
function refreshTemplateCards() {
    // Clear selection when refreshing
    if (typeof clearSelection === 'function') {
        clearSelection();
    }
    
    // Find the filter form and trigger it to refresh the cards
    const templateForm = document.querySelector('form[hx-target="#template-management-cards"]');
    if (templateForm) {
        htmx.trigger(templateForm, 'submit');
    } else {
        // Fallback to page reload if form not found
        location.reload();
    }
}

function duplicateTemplate(templateId, templateName) {
    if (confirm(`Do you want to duplicate "${templateName}" template?`)) {
        fetch(`/template-management/duplicate/${templateId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `new_name=${encodeURIComponent(templateName + ' (Copy)')}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                alert(data.message);
                refreshTemplateCards();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while duplicating the template');
        });
    }
}

function deleteTemplate(templateId, templateName) {
    if (confirm(`Are you sure you want to delete "${templateName}" template?`)) {
        fetch(`/template-management/delete/${templateId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'force_delete=false'
        })
        .then(response => response.json())
        .then(data => {
            if (data.warning) {
                if (confirm(data.message + '\n\nThis will create separate copies for each building. Continue?')) {
                    // Force delete with confirmation
                    return fetch(`/template-management/delete/${templateId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: 'force_delete=true'
                    });
                }
                return null;
            } else if (data.error) {
                alert('Error: ' + data.error);
            } else {
                alert(data.message);
                refreshTemplateCards();
            }
            return null;
        })
        .then(response => {
            if (response) {
                return response.json();
            }
            return null;
        })
        .then(data => {
            if (data) {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert(data.message);
                    refreshTemplateCards();
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the template');
        });
    }
}
</script>