{% load custom_filters %}

{% if user_templates %}
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="text-primary mb-0">Your Templates</h5>
        <span class="badge bg-primary">{{ user_templates.paginator.count }} template{{ user_templates.paginator.count|pluralize }}</span>
    </div>
    
    <div class="row">
        {% for template in user_templates %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100" data-template-id="{{ template.id }}" data-template-name="{{ template.name }}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="d-flex align-items-center">
                            <input type="checkbox" class="form-check-input template-checkbox me-2" 
                                   onchange="toggleTemplateSelection('{{ template.id }}', this)">
                            <h6 class="card-title mb-0">{{ template.name }}</h6>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item" href="{% url 'component_edit' assembly_id=template.id building_id='00000000-0000-0000-0000-000000000000' %}?template_edit=true">
                                        <i class="fas fa-edit me-2"></i>Edit Template
                                    </a>
                                </li>
                                <li>
                                    <button class="dropdown-item" onclick="duplicateTemplate('{{ template.id }}', '{{ template.name }}')">
                                        <i class="fas fa-copy me-2"></i>Duplicate
                                    </button>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <button class="dropdown-item text-danger" onclick="deleteTemplate('{{ template.id }}', '{{ template.name }}')">
                                        <i class="fas fa-trash me-2"></i>Delete
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="small text-muted mb-3">
                        <div><strong>Category:</strong> {{ template.classification.category|default:"Not specified" }}</div>
                        <div><strong>Technique:</strong> {{ template.classification.technique|default:"Not specified" }}</div>
                        <div><strong>Dimension:</strong> {{ template.get_dimension_display }}</div>
                        <div><strong>Materials:</strong> {{ template.structuralproduct_set.count }} item{{ template.structuralproduct_set.count|pluralize }}</div>
                        <div><strong>Country:</strong> {{ template.country.name|default:"Not specified" }}</div>
                        <div><strong>Created:</strong> {{ template.created_at|date:"M d, Y" }}</div>
                    </div>
                    
                    {% if template.comment %}
                    <p class="card-text small mb-3">{{ template.comment|truncatewords:15 }}</p>
                    {% endif %}
                    
                    <div class="d-flex gap-2">
                        <span class="badge bg-success">
                            <i class="fas fa-check me-1"></i>Template Active
                        </span>
                        {% if template.mode == 'generic' %}
                        <span class="badge bg-info">
                            <i class="fas fa-globe me-1"></i>Generic
                        </span>
                        {% else %}
                        <span class="badge bg-secondary">
                            <i class="fas fa-user me-1"></i>Custom
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pagination for user templates -->
    {% if user_templates.has_other_pages %}
    <nav aria-label="Template pagination" class="mb-4">
        <ul class="pagination justify-content-center">
            {% if user_templates.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1">&laquo; First</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ user_templates.previous_page_number }}">Previous</a>
                </li>
            {% endif %}
            
            <li class="page-item active">
                <span class="page-link">
                    Page {{ user_templates.number }} of {{ user_templates.paginator.num_pages }}
                </span>
            </li>
            
            {% if user_templates.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ user_templates.next_page_number }}">Next</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ user_templates.paginator.num_pages }}">Last &raquo;</a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>
{% endif %}

{% if generic_templates %}
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="text-success mb-0">Generic Templates</h5>
        <span class="small text-muted">Showing first 6 generic templates</span>
    </div>
    
    <div class="row">
        {% for template in generic_templates %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100 border-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0">{{ template.name }}</h6>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <button class="dropdown-item" onclick="duplicateTemplate('{{ template.id }}', '{{ template.name }}')">
                                        <i class="fas fa-copy me-2"></i>Copy to My Templates
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="small text-muted mb-3">
                        <div><strong>Category:</strong> {{ template.classification.category|default:"Not specified" }}</div>
                        <div><strong>Technique:</strong> {{ template.classification.technique|default:"Not specified" }}</div>
                        <div><strong>Dimension:</strong> {{ template.get_dimension_display }}</div>
                        <div><strong>Materials:</strong> {{ template.structuralproduct_set.count }} item{{ template.structuralproduct_set.count|pluralize }}</div>
                        <div><strong>Country:</strong> {{ template.country.name|default:"Global" }}</div>
                    </div>
                    
                    {% if template.comment %}
                    <p class="card-text small mb-3">{{ template.comment|truncatewords:15 }}</p>
                    {% endif %}
                    
                    <div class="d-flex gap-2">
                        <span class="badge bg-success">
                            <i class="fas fa-globe me-1"></i>Generic Template
                        </span>
                        <span class="badge bg-light text-dark">
                            <i class="fas fa-eye me-1"></i>Read Only
                        </span>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if not user_templates and not generic_templates %}
<div class="text-center py-5">
    <div class="mb-4">
        <i class="fas fa-layer-group fa-3x text-muted"></i>
    </div>
    <h4 class="text-muted mb-3">No Templates Found</h4>
    <p class="text-muted mb-4">You haven't created any templates yet, or no templates match your current filters.</p>
    <div class="d-flex gap-2 justify-content-center">
        <a href="{% url 'home' %}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Create Your First Assembly
        </a>
        <button type="button" class="btn btn-outline-secondary" onclick="document.querySelector('form').reset(); document.querySelector('form').submit();">
            <i class="fas fa-filter me-2"></i>Clear Filters
        </button>
    </div>
</div>
{% elif not user_templates %}
<div class="text-center py-4 mb-4">
    <div class="mb-3">
        <i class="fas fa-user-plus fa-2x text-muted"></i>
    </div>
    <h5 class="text-muted mb-2">No Personal Templates</h5>
    <p class="text-muted mb-3">Create assemblies in your buildings and mark them as templates to reuse them.</p>
    <a href="{% url 'home' %}" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>Go to Buildings
    </a>
</div>
{% endif %}

<script>
function refreshTemplateCards() {
    // Clear selection when refreshing
    if (typeof clearSelection === 'function') {
        clearSelection();
    }
    
    // Find the filter form and trigger it to refresh the cards
    const templateForm = document.querySelector('form[hx-target="#template-management-cards"]');
    if (templateForm) {
        htmx.trigger(templateForm, 'submit');
    } else {
        // Fallback to page reload if form not found
        location.reload();
    }
}

function duplicateTemplate(templateId, templateName) {
    if (confirm(`Do you want to duplicate "${templateName}" template?`)) {
        fetch(`/template-management/duplicate/${templateId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `new_name=${encodeURIComponent(templateName + ' (Copy)')}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                alert(data.message);
                refreshTemplateCards();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while duplicating the template');
        });
    }
}

function deleteTemplate(templateId, templateName) {
    if (confirm(`Are you sure you want to delete "${templateName}" template?`)) {
        fetch(`/template-management/delete/${templateId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'force_delete=false'
        })
        .then(response => response.json())
        .then(data => {
            if (data.warning) {
                if (confirm(data.message + '\n\nThis will create separate copies for each building. Continue?')) {
                    // Force delete with confirmation
                    return fetch(`/template-management/delete/${templateId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: 'force_delete=true'
                    });
                }
                return null;
            } else if (data.error) {
                alert('Error: ' + data.error);
            } else {
                alert(data.message);
                refreshTemplateCards();
            }
            return null;
        })
        .then(response => {
            if (response) {
                return response.json();
            }
            return null;
        })
        .then(data => {
            if (data) {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert(data.message);
                    refreshTemplateCards();
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the template');
        });
    }
}
</script>