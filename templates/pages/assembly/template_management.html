{% extends "_base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load custom_filters %}

{% block title %}Template Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="mb-4">
        <h2 class="mb-1">Assembly Template Management</h2>
        <p class="text-muted">Manage your assembly templates and discover generic ones</p>
    </div>

    <!-- Filter Form -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">Filter Templates</h5>
            <form hx-post="{% url 'assembly_template_management' %}"
                  hx-target="#template-management-cards" 
                  hx-vals='{"action": "filter"}'>
                {% csrf_token %}
                {% crispy template_filters_form %}
            </form>
        </div>
    </div>

    <!-- Bulk Actions Bar -->
    <div id="bulk-actions-bar" class="card mb-3" style="display: none;">
        <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span id="selected-count">0</span> template(s) selected
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="bulkDuplicate()">
                        <i class="fas fa-copy me-1"></i>Duplicate Selected
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="bulkDelete()">
                        <i class="fas fa-trash me-1"></i>Delete Selected
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                        <i class="fas fa-times me-1"></i>Clear Selection
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Cards Container -->
    <div id="template-management-cards">
        {% include "pages/assembly/management_template_cards.html" %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="delete-message">Are you sure you want to delete this template?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Duplicate Template Modal -->
<div class="modal fade" id="duplicateModal" tabindex="-1" aria-labelledby="duplicateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="duplicateModalLabel">Duplicate Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="duplicate-form">
                    <div class="mb-3">
                        <label for="new-template-name" class="form-label">New Template Name</label>
                        <input type="text" class="form-control" id="new-template-name" name="new_name" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-duplicate-btn">Duplicate</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Duplicate Confirmation Modal -->
<div class="modal fade" id="bulkDuplicateModal" tabindex="-1" aria-labelledby="bulkDuplicateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkDuplicateModalLabel">Confirm Bulk Duplicate</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="bulk-duplicate-message">Are you sure you want to duplicate the selected templates?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-bulk-duplicate-btn">Duplicate</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentDeleteUrl = '';
    let currentDuplicateUrl = '';
    
    // Handle delete confirmation
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-template-btn')) {
            e.preventDefault();
            const templateName = e.target.dataset.templateName;
            const deleteUrl = e.target.dataset.deleteUrl;
            
            currentDeleteUrl = deleteUrl;
            document.getElementById('delete-message').textContent = 
                `Are you sure you want to delete the template "${templateName}"?`;
            
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        }
        
        if (e.target.classList.contains('duplicate-template-btn')) {
            e.preventDefault();
            const templateName = e.target.dataset.templateName;
            const duplicateUrl = e.target.dataset.duplicateUrl;
            
            currentDuplicateUrl = duplicateUrl;
            document.getElementById('new-template-name').value = `${templateName} (Copy)`;
            
            const modal = new bootstrap.Modal(document.getElementById('duplicateModal'));
            modal.show();
        }
    });
    
    // Confirm delete
    document.getElementById('confirm-delete-btn').addEventListener('click', function() {
        const isBulkDelete = this.getAttribute('data-bulk-delete') === 'true';

        if (isBulkDelete) {
            const promises = Array.from(selectedTemplates).map(templateId => {
                return fetch(`/template-management/delete/${templateId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'force_delete=true'
                });
            });

            Promise.allSettled(promises).then(results => {
                const successful = results.filter(r => r.status === 'fulfilled').length;
                const failed = results.length - successful;

                let message = '';
                if (failed === 0) {
                    message = `Successfully deleted ${successful} template(s)`;
                } else {
                    message = `Deleted ${successful} template(s). ${failed} failed.`;
                }

                document.getElementById('delete-message').innerHTML = `<div class="alert alert-success mb-0">${message}</div>`;

                const confirmBtn = document.getElementById('confirm-delete-btn');
                confirmBtn.textContent = 'Close';
                confirmBtn.onclick = function() {
                    bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
                    clearSelection();
                    location.reload();
                };
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('delete-message').innerHTML = `<div class="alert alert-danger mb-0">An error occurred while deleting templates</div>`;
            });

            this.removeAttribute('data-bulk-delete');

        } else if (currentDeleteUrl) {
            fetch(currentDeleteUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'force_delete=true'
            })
            .then(response => response.json())
            .then(data => {
                if (data.warning) {
                    document.getElementById('delete-message').textContent = data.message;
                    return;
                }
                
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {

                    location.reload();
                }
                
                bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the template');
                bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
            });
        }
    });

    // Confirm bulk duplicate
    document.getElementById('confirm-bulk-duplicate-btn').addEventListener('click', function() {
        const promises = Array.from(selectedTemplates).map(templateId => {
            const templateName = document.querySelector(`[data-template-id="${templateId}"]`).dataset.templateName;
            return fetch(`/template-management/duplicate/${templateId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `new_name=${encodeURIComponent(templateName + ' (Copy)')}`
            });
        });

        Promise.allSettled(promises).then(results => {
            const successful = results.filter(r => r.status === 'fulfilled').length;
            const failed = results.length - successful;

            let message = '';
            if (failed === 0) {
                message = `Successfully duplicated ${successful} template(s)`;
            } else {
                message = `Duplicated ${successful} template(s). ${failed} failed.`;
            }

            // Show success message in the modal
            document.getElementById('bulk-duplicate-message').innerHTML = `<div class="alert alert-success mb-0">${message}</div>`;

            // Change button text and behavior
            const confirmBtn = document.getElementById('confirm-bulk-duplicate-btn');
            confirmBtn.textContent = 'Close';
            confirmBtn.onclick = function() {
                bootstrap.Modal.getInstance(document.getElementById('bulkDuplicateModal')).hide();
                clearSelection();
                location.reload();
            };
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('bulk-duplicate-message').innerHTML = `<div class="alert alert-danger mb-0">An error occurred while duplicating templates</div>`;
        });
    });

    // Confirm duplicate
    document.getElementById('confirm-duplicate-btn').addEventListener('click', function() {
        const newName = document.getElementById('new-template-name').value.trim();
        
        if (!newName) {
            alert('Please enter a name for the duplicated template');
            return;
        }
        
        if (currentDuplicateUrl) {
            fetch(currentDuplicateUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `new_name=${encodeURIComponent(newName)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    // Reload the page to show the new template
                    location.reload();
                }
                
                bootstrap.Modal.getInstance(document.getElementById('duplicateModal')).hide();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while duplicating the template');
                bootstrap.Modal.getInstance(document.getElementById('duplicateModal')).hide();
            });
        }
    });
});

// Bulk Actions JavaScript
let selectedTemplates = new Set();

function updateBulkActionsBar() {
    const count = selectedTemplates.size;
    const bulkBar = document.getElementById('bulk-actions-bar');
    const countSpan = document.getElementById('selected-count');
    
    if (count > 0) {
        bulkBar.style.display = 'block';
        countSpan.textContent = count;
    } else {
        bulkBar.style.display = 'none';
    }
}

function toggleTemplateSelection(templateId, checkbox) {
    if (checkbox.checked) {
        selectedTemplates.add(templateId);
    } else {
        selectedTemplates.delete(templateId);
    }
    updateBulkActionsBar();
}

function clearSelection() {
    selectedTemplates.clear();
    document.querySelectorAll('.template-checkbox').forEach(cb => cb.checked = false);
    updateBulkActionsBar();
}

function bulkDuplicate() {
    if (selectedTemplates.size === 0) return;

    // Use Bootstrap modal instead of confirm()
    const templateCount = selectedTemplates.size;
    const templateText = templateCount === 1 ? 'template' : 'templates';

    document.getElementById('bulk-duplicate-message').textContent =
        `Are you sure you want to duplicate ${templateCount} selected ${templateText}? Each will be named "[Original Name] (Copy)".`;

    const modal = new bootstrap.Modal(document.getElementById('bulkDuplicateModal'));
    modal.show();
}

function bulkDelete() {
    if (selectedTemplates.size === 0) return;

    const templateCount = selectedTemplates.size;
    const templateText = templateCount === 1 ? 'template' : 'templates';

    currentDeleteUrl = null; // Clear individual delete URL
    document.getElementById('delete-message').textContent =
        `Are you sure you want to delete ${templateCount} selected ${templateText}?`;
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    modal.show();

    document.getElementById('confirm-delete-btn').setAttribute('data-bulk-delete', 'true');
}
</script>

{% endblock %}