{% load static %}
{% load cookie_consent_tags %}
{% load newrelic_tags %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
  <title class="title">{% block title %}BEAT{% endblock title %}</title>
  <meta name="description" content="A framework for launching new Django projects quickly.">
  <meta name="author" content="">
  <link rel="shortcut icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
  
  {% if request|cookie_group_accepted:"analytics" %}
    {% newrelic_browser_timing_header %}
  {% endif %}

  {% block css %}
  <!-- Bootstrap CSS -->
  {% load static %}
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/bootstrap-icons.min.css' %}">
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  {% endblock css%}
  
  <!-- Cookie Banner CSS - Always included -->
  <link rel="stylesheet" href="{% static 'css/cookie-consent.css' %}">

</head>

<body hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}' class="d-flex flex-column h-100 min-vh-100 {% block body_class %}{% endblock %}">
  {% if user.is_authenticated %}
  <nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
      <a class="navbar-brand title" href="{% url 'home' %}">BEAT</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="{% url 'home' %}">Overview</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'resources' %}">Resources</a>
          </li>
        </ul>
        <div class="mr-auto">
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                aria-expanded="false">
                Settings
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="{% url 'update_profile' %}">{{ user.email }}</a></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="{% url 'account_change_password' %}">Change password</a></li>
                <li><a class="dropdown-item" href="#" onclick="showCookieSettings()">Cookie Settings</a></li>
                <li><a class="dropdown-item" href="{% url 'account_logout' %}">Sign out</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </nav>
  {% endif %}

  {% if messages %}
  <div class="container mt-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible d-flex align-items-center justify-content-between" role="alert">
        <span>{{ message }}</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <div class="container pb-2 mt-2 flex-grow-1">
    {% block content %}
    <p>Default content...</p>
    {% endblock content %}
  </div>

  {% if user.is_authenticated %}
  {% include 'footer.html' %}
  {% endif %}

  <!-- Cookie Consent Banner -->
  {% if not request|all_cookies_accepted and not request.COOKIES.banner_shown %}
  <div id="cookieBanner" class="cookie-banner">
    <div class="container-fluid">
      <div class="cookie-content">
        <div class="cookie-text">
          <h5><i class="bi bi-shield-check"></i> We Value Your Privacy</h5>
          <p>We use cookies to enhance your experience, provide analytics, and enable embedded content. You can manage your preferences at any time.</p>
        </div>
        <div class="cookie-actions">
          <button type="button" class="cookie-btn cookie-btn-accept" onclick="acceptAllCookies()">
            Accept All
          </button>
          <button type="button" class="cookie-btn cookie-btn-decline" onclick="declineOptionalCookies()">
            Decline Optional
          </button>
          <button type="button" class="cookie-btn cookie-btn-settings" onclick="showCookieSettings()">
            Manage Preferences
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Cookie Settings Modal -->
  <div class="modal fade cookie-settings-modal" id="cookieSettingsModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-gear"></i> Cookie Settings</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-4">
            Manage your cookie preferences below. Essential cookies are required for the website to function properly.
          </p>

          <div id="cookieCategories">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" onclick="declineOptionalCookies()">Decline Optional</button>
          <button type="button" class="btn btn-success" onclick="saveCustomSettings()">Save Preferences</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function showCookieBanner() {
      const banner = document.getElementById('cookieBanner');
      if (banner) {
        setTimeout(() => {
          banner.classList.add('show');
        }, 500);
      }
    }

    function hideCookieBanner() {
      const banner = document.getElementById('cookieBanner');
      if (banner) {
        banner.classList.remove('show');
      }
    }

    function setBannerShownCookie() {
      const expires = new Date();
      expires.setDate(expires.getDate() + 30);
      document.cookie = `banner_shown=true; expires=${expires.toUTCString()}; path=/`;
    }

    function acceptAllCookies() {
      fetch('/cookies/accept/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/x-www-form-urlencoded',
        }
      }).then(response => {
        if (response.ok) {
          setBannerShownCookie();
          hideCookieBanner();
          const modal = bootstrap.Modal.getInstance(document.getElementById('cookieSettingsModal'));
          if (modal) modal.hide();
          setTimeout(() => location.reload(), 300);
        }
      }).catch(error => {
        console.error('Error accepting cookies:', error);
      });
    }

    function declineOptionalCookies() {
      fetch('/cookies/decline/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/x-www-form-urlencoded',
        }
      }).then(response => {
        if (response.ok) {
          setBannerShownCookie();
          hideCookieBanner();
          const modal = bootstrap.Modal.getInstance(document.getElementById('cookieSettingsModal'));
          if (modal) modal.hide();
          setTimeout(() => location.reload(), 300);
        }
      }).catch(error => {
        console.error('Error declining cookies:', error);
      });
    }

    function showCookieSettings() {
      loadCookieCategories();
      const modal = new bootstrap.Modal(document.getElementById('cookieSettingsModal'));
      modal.show();
    }

    function loadCookieCategories() {
      fetch('{% url "cookie_groups" %}')
        .then(response => response.json())
        .then(data => {
          const container = document.getElementById('cookieCategories');
          container.innerHTML = '';

          data.groups.forEach(group => {
            let cookiesHtml = '';
            if (group.cookies && group.cookies.length > 0) {
              cookiesHtml = `
                <div class="cookies-list">
                  ${group.cookies.map(cookie => `
                    <div class="cookie-item">
                      <div class="cookie-name">${cookie.name}</div>
                      ${cookie.description ? `<div class="cookie-description">${cookie.description}</div>` : ''}
                    </div>
                  `).join('')}
                </div>
              `;
            }

            const categoryHtml = `
              <div class="cookie-category ${group.required ? 'required' : ''}">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <h6>${group.name}</h6>
                    <p class="description">${group.description}</p>
                    ${cookiesHtml}
                  </div>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="cookie-${group.id}"
                           ${group.enabled ? 'checked' : ''}
                           ${group.required ? 'disabled' : ''}>
                    <label class="form-check-label" for="cookie-${group.id}">
                      ${group.required ? 'Always Active' : 'Enable'}
                    </label>
                  </div>
                </div>
              </div>
            `;
            container.innerHTML += categoryHtml;
          });
        })
        .catch(error => {
          console.error('Error loading cookie categories:', error);
        });
    }

    function saveCustomSettings() {
      fetch('{% url "cookie_groups" %}')
        .then(response => response.json())
        .then(data => {
          return data.groups.reduce((promise, group) => {
            return promise.then((results) => {
              const checkbox = document.getElementById(`cookie-${group.id}`);
              if (checkbox) {
                const isEnabled = group.required ? true : checkbox.checked;
                const url = isEnabled ? `/cookies/accept/${group.id}/` : `/cookies/decline/${group.id}/`;

                return fetch(url, {
                  method: 'POST',
                  headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/x-www-form-urlencoded',
                  }
                }).then(response => {
                  if (!response.ok) {
                    console.error(`Failed to save ${group.id} cookie setting:`, response.status);
                    throw new Error(`Failed to save ${group.id} cookie setting`);
                  }
                  return [...results, response];
                });
              }
              return results;
            });
          }, Promise.resolve([]));
        })
        .then(responses => {
          console.log('All cookie settings saved successfully');
          setBannerShownCookie();
          hideCookieBanner();
          const modal = bootstrap.Modal.getInstance(document.getElementById('cookieSettingsModal'));
          if (modal) modal.hide();
          setTimeout(() => location.reload(), 500);
        })
        .catch(error => {
          console.error('Error saving cookie settings:', error);
          alert('Failed to save cookie preferences. Please try again.');
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
      {% if not request|all_cookies_accepted and not request.COOKIES.banner_shown %}
        showCookieBanner();
      {% endif %}
    });
  </script>

  {% block javascript %}
  <!-- Bootstrap JavaScript -->
  <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>

  <!-- Project JS -->
  <script src="{% static 'js/base.js' %}"></script>

  <!-- HTMX -->
  <script src="{% static 'js/htmx1.6.1/htmx.min.js' %}"></script>
  {% endblock javascript %}
  
  {% if request|cookie_group_accepted:"analytics" %}
    {% newrelic_browser_timing_footer %}
  {% endif %}
</body>

</html>